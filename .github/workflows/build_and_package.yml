name: Build and Package PyGitHubRipper

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install pyinstaller requests beautifulsoup4 streamlit

    - name: Clean up old build artifacts
      run: |
        Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force builds -ErrorAction SilentlyContinue

    - name: Build launch.exe
      run: |
        pyinstaller --onefile --icon=icon.ico launch.py
        $buildsDir = "builds"
        if (!(Test-Path $buildsDir)) {
          New-Item -ItemType Directory -Force -Path $buildsDir
        }
        Move-Item -Path dist\launch.exe -Destination "$buildsDir\launch.exe" -Force

    - name: Increment version
      id: increment_version
      run: |
        $versionFile = "VERSION"
        if (Test-Path $versionFile) {
          $version = Get-Content $versionFile
        } else {
          $version = "0.0.0"
        }
        $addr = $version -split '\.'
        $patch = [int]$addr[2] + 1
        $newVersion = "$($addr[0]).$($addr[1]).$patch"
        $newVersion > $versionFile
        echo "::set-output name=new_version::$newVersion"

    - name: Commit changes
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add .
        git commit -m "Build and package version ${{ steps.increment_version.outputs.new_version }}"
        git tag "v${{ steps.increment_version.outputs.new_version }}"
        git push origin main --tags

    - name: Final clean up
      run: |
        Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force builds -ErrorAction SilentlyContinue
